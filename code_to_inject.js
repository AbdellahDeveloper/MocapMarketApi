(function () {    const existingOverlay = document.getElementById('custom-overlay');    if (existingOverlay) {        existingOverlay.parentNode.removeChild(existingOverlay);        console.log('Removed existing overlay before creating a new one');    }    const overlay = document.createElement('div');    overlay.id = 'custom-overlay';    const tailwindStyles = document.createElement('style');    tailwindStyles.textContent = `        #custom-overlay .bg-gray-900 { background-color: rgba(17, 24, 39, 1); }        #custom-overlay .bg-opacity-95 { --tw-bg-opacity: 0.95; }        #custom-overlay .text-white { color: rgba(255, 255, 255, 1); }        #custom-overlay .rounded-lg { border-radius: 0.5rem; }        #custom-overlay .shadow-2xl { box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }        #custom-overlay .border { border-width: 1px; }        #custom-overlay .border-gray-700 { border-color: rgba(55, 65, 81, 1); }        #custom-overlay .overflow-hidden { overflow: hidden; }        #custom-overlay .bg-gradient-to-r { background-image: linear-gradient(to right, var(--tw-gradient-stops)); }        #custom-overlay .from-red-900 { --tw-gradient-from: rgba(127, 29, 29, 1); --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to, rgba(127, 29, 29, 0)); }        #custom-overlay .to-gray-800 { --tw-gradient-to: rgba(31, 41, 55, 1); }        #custom-overlay .p-4 { padding: 1rem; }        #custom-overlay .p-5 { padding: 1.25rem; }        #custom-overlay .cursor-move { cursor: move; }        #custom-overlay .flex { display: flex; }        #custom-overlay .justify-between { justify-content: space-between; }        #custom-overlay .justify-end { justify-content: flex-end; }        #custom-overlay .items-center { align-items: center; }        #custom-overlay .items-start { align-items: flex-start; }        #custom-overlay .text-3xl { font-size: 1.875rem; line-height: 2.25rem; }        #custom-overlay .text-xl { font-size: 1.25rem; line-height: 1.75rem; }        #custom-overlay .text-sm { font-size: 0.875rem; line-height: 1.25rem; }        #custom-overlay .font-bold { font-weight: 700; }        #custom-overlay .font-medium { font-weight: 500; }        #custom-overlay .h-8 { height: 2rem; }        #custom-overlay .w-8 { width: 2rem; }        #custom-overlay .h-6 { height: 1.5rem; }        #custom-overlay .w-6 { width: 1.5rem; }        #custom-overlay .h-5 { height: 1.25rem; }        #custom-overlay .w-5 { width: 1.25rem; }        #custom-overlay .h-4 { height: 1rem; }        #custom-overlay .w-4 { width: 1rem; }        #custom-overlay .mr-2 { margin-right: 0.5rem; }        #custom-overlay .mr-1 { margin-right: 0.25rem; }        #custom-overlay .mt-1 { margin-top: 0.25rem; }        #custom-overlay .mt-2 { margin-top: 0.5rem; }        #custom-overlay .mb-3 { margin-bottom: 0.75rem; }        #custom-overlay .mt-0\\.5 { margin-top: 0.125rem; }        #custom-overlay .text-red-600 { color: rgba(220, 38, 38, 1); }        #custom-overlay .text-gray-300 { color: rgba(209, 213, 219, 1); }        #custom-overlay .text-gray-200 { color: rgba(229, 231, 235, 1); }        #custom-overlay .text-yellow-500 { color: rgba(245, 158, 11, 1); }        #custom-overlay .bg-gray-700 { background-color: rgba(55, 65, 81, 1); }        #custom-overlay .hover\\:bg-gray-600:hover { background-color: rgba(75, 85, 99, 1); }        #custom-overlay .bg-gray-800 { background-color: rgba(31, 41, 55, 1); }        #custom-overlay .bg-opacity-50 { --tw-bg-opacity: 0.5; }        #custom-overlay .bg-red-700 { background-color: rgba(185, 28, 28, 1); }        #custom-overlay .hover\\:bg-red-600:hover { background-color: rgba(220, 38, 38, 1); }        #custom-overlay .bg-green-700 { background-color: rgba(4, 120, 87, 1); }        #custom-overlay .hover\\:bg-green-600:hover { background-color: rgba(5, 150, 105, 1); }        #custom-overlay .py-1 { padding-top: 0.25rem; padding-bottom: 0.25rem; }        #custom-overlay .px-3 { padding-left: 0.75rem; padding-right: 0.75rem; }        #custom-overlay .rounded { border-radius: 0.25rem; }        #custom-overlay .rounded-md { border-radius: 0.375rem; }        #custom-overlay .transition { transition-property: background-color, border-color, color, fill, stroke, opacity, box-shadow, transform, filter, backdrop-filter; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 150ms; }        #custom-overlay .duration-200 { transition-duration: 200ms; }        #custom-overlay .italic { font-style: italic; }        #custom-overlay .space-y-4 > * + * { margin-top: 1rem; }        #custom-overlay .space-y-2 > * + * { margin-top: 0.5rem; }        #custom-overlay .space-x-2 > * + * { margin-left: 0.5rem; }        #custom-overlay .flex-shrink-0 { flex-shrink: 0; }        #custom-overlay .bg-red-100 { background-color: rgba(254, 226, 226, 1); }        #custom-overlay .text-red-800 { color: rgba(153, 27, 27, 1); }        #custom-overlay .border-red-400 { border-color: rgba(248, 113, 113, 1); }        #custom-overlay .px-4 { padding-left: 1rem; padding-right: 1rem; }        #custom-overlay .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }        #custom-overlay .font-semibold { font-weight: 600; }        #custom-overlay .ml-1 { margin-left: 0.25rem; }        #custom-overlay .bg-gray-700 { background-color: rgba(55, 65, 81, 1); }        #custom-overlay .bg-red-900 { background-color: rgba(127, 29, 29, 1); }        #custom-overlay .ml-2 { margin-left: 0.5rem; }        #custom-overlay .flex-col { flex-direction: column; }        #custom-overlay .flex-row { flex-direction: row; }    `;    document.head.appendChild(tailwindStyles);    let initialRoomIdDisplay = '';    let initialRoomIdInfo = '';    const currentUrl = window.location.href;    const isRoomPage = currentUrl.includes('mocapmarketapi.onrender.com/');    if (isRoomPage) {        const urlParts = currentUrl.split('/');        const roomIndex = urlParts.indexOf('room');        if (roomIndex !== -1 && roomIndex < urlParts.length - 1) {            const roomId = urlParts[roomIndex + 1];            if (roomId) {                initialRoomIdInfo = `                <div class="bg-gray-700 px-4 py-2 rounded-md text-white flex items-center">                    <span class="ml-2 px-3 py-1 rounded">${roomId}</span>                </div>`;                fetchRoomInformation(roomId);            }        }    }    overlay.innerHTML = `        <div class="bg-gray-900 bg-opacity-95 text-white rounded-lg shadow-2xl border border-gray-700 overflow-hidden"             style="font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; width: 22rem; font-size: 0.9rem;">            <!-- Header -->            <div class="bg-gradient-to-r from-red-900 to-gray-800 p-3 cursor-move" id="overlay-header">                <div class="flex justify-between items-center">                    <h1 class="text-2xl font-bold flex items-center">                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-red-600" viewBox="0 0 20 20" fill="currentColor">                            <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3zM6 8a2 2 0 11-4 0 2 2 0 014 0zM16 18v-3a5.972 5.972 0 00-.75-2.906A3.005 3.005 0 0119 15v3h-3zM4.75 12.094A5.973 5.973 0 004 15v3H1v-3a3 3 0 013.75-2.906z" />                        </svg>                        <span class="text-red-600">Mafia</span>                        <span class="text-gray-300">Cheat</span>                    </h1>                    <button id="minimize-btn" class="bg-gray-700 hover:bg-gray-600 text-white font-medium py-1 px-2 rounded text-xs transition duration-200 flex items-center">                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" class="mr-1" viewBox="0 0 20 20" fill="currentColor">                            <path fill-rule="evenodd" d="M5 10a1 1 0 011-1h8a1 1 0 110 2H6a1 1 0 01-1-1z" clip-rule="evenodd" />                        </svg>                        Minimize                    </button>                </div>                <p class="text-yellow-500 text-xs italic flex items-center mt-1">                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" class="mr-1" viewBox="0 0 20 20" fill="currentColor">                        <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />                    </svg>                    Made by Abdellah El Idrissi                </p>            </div>                        <!-- Content -->            <div class="p-4 space-y-3" id="overlay-content">                <!-- Room ID Section -->                <div class="bg-gray-800 bg-opacity-50 p-3 rounded-md">                    <h2 class="text-lg font-bold text-yellow-500 mb-2 flex items-center">                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">                            <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd" />                        </svg>                        Room Informations                    </h2>                                        <div id="room-id-info" class="mb-2">                        ${initialRoomIdInfo || `                        <p class="text-gray-300 text-sm">                            Current room information will appear here when you join a room.                        </p>`}                    </div>                                        <!-- Add room control buttons -->                    <div id="room-control-buttons" class="flex space-x-2 mt-2">                        <button id="start-game-btn" class="w-full bg-green-700 hover:bg-green-600 text-white font-medium py-1 px-2 rounded text-xs transition duration-200 flex items-center justify-center cursor-pointer">                            <svg width="16" height="16" xmlns="http://www.w3.org/2000/svg" class="mr-1" viewBox="0 0 20 20" fill="currentColor">                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />                            </svg>                            <div class="flex flex-col">                                Re/Start Game                            </div>                        </button>                        <button id="delete-room-btn" class="w-full bg-red-700 hover:bg-red-600 text-white font-medium py-1 px-2 rounded text-xs transition duration-200 flex items-center justify-center cursor-pointer">                            <svg width="16" height="16" xmlns="http://www.w3.org/2000/svg" class="mr-1" viewBox="0 0 20 20" fill="currentColor">                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />                            </svg>                            Delete Room                        </button>                    </div>                </div>                                <!-- Pending Players Section -->                <div class="bg-gray-800 bg-opacity-50 p-3 rounded-md">                    <h2 class="text-lg font-bold text-yellow-500 mb-2 flex items-center">                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">                            <path d="M8 9a3 3 0 100-6 3 3 0 000 6zM8 11a6 6 0 016 6H2a6 6 0 016-6zM16 7a1 1 0 10-2 0v1h-1a1 1 0 100 2h1v1a1 1 0 102 0v-1h1a1 1 0 100-2h-1V7z" />                        </svg>                        Pending Players                    </h2>                                        <div id="pending-players-container" class="space-y-2">                        <!-- Pending players will be populated here -->                    </div>                </div>                                <!-- Players Section -->                <div class="bg-gray-800 bg-opacity-50 p-3 rounded-md">                    <h2 class="text-lg font-bold text-yellow-500 mb-2 flex items-center">                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" class="mr-2" viewBox="0 0 20 20" fill="currentColor">                            <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3zM6 8a2 2 0 11-4 0 2 2 0 014 0zM16 18v-3a5.972 5.972 0 00-.75-2.906A3.005 3.005 0 0119 15v3h-3zM4.75 12.094A5.973 5.973 0 004 15v3H1v-3a3 3 0 013.75-2.906z" />                        </svg>                        Players                    </h2>                                        <p class="text-gray-300 mb-2 text-xs">                        Player information will be displayed here.                    </p>                                        <div id="players-container" class="space-y-2">                        <!-- Player list will be populated here -->                    </div>                </div>                                <!-- Close Button -->                <div class="flex justify-end">                    <button id="close-btn" class="bg-red-700 hover:bg-red-600 text-white font-medium py-1 px-2 rounded text-xs transition duration-200 flex items-center">                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" class="mr-1" viewBox="0 0 20 20" fill="currentColor">                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />                        </svg>                        Close                    </button>                </div>            </div>        </div>    `;    overlay.style.position = 'fixed';    overlay.style.top = '20px';    overlay.style.right = '20px';    overlay.style.zIndex = '10000';    overlay.style.userSelect = 'none';    overlay.style.maxHeight = 'calc(100vh - 40px)';    overlay.style.overflowY = 'auto';    overlay.style.scrollbarWidth = 'none';    overlay.style.msOverflowStyle = 'none';    const styleElement = document.createElement('style');    styleElement.textContent = `        #custom-overlay::-webkit-scrollbar {            display: none;        }    `;    document.head.appendChild(styleElement);    document.body.appendChild(overlay);    const header = document.getElementById('overlay-header');    let isDragging = false;    let offsetX, offsetY;    header.addEventListener('mousedown', (e) => {        isDragging = true;        offsetX = e.clientX - overlay.getBoundingClientRect().left;        offsetY = e.clientY - overlay.getBoundingClientRect().top;    });    document.addEventListener('mousemove', (e) => {        if (isDragging) {            overlay.style.left = (e.clientX - offsetX) + 'px';            overlay.style.top = (e.clientY - offsetY) + 'px';            overlay.style.right = 'auto';        }    });    document.addEventListener('mouseup', () => {        isDragging = false;    });    let isMinimized = false;    const minimizeBtn = document.getElementById('minimize-btn');    const content = document.getElementById('overlay-content');    minimizeBtn.addEventListener('click', () => {        if (isMinimized) {            content.style.display = 'block';            minimizeBtn.innerHTML = `                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" class="mr-1" viewBox="0 0 20 20" fill="currentColor">                    <path fill-rule="evenodd" d="M5 10a1 1 0 011-1h8a1 1 0 110 2H6a1 1 0 01-1-1z" clip-rule="evenodd" />                </svg>                Minimize            `;        } else {            content.style.display = 'none';            minimizeBtn.innerHTML = `                +                Expand            `;        }        isMinimized = !isMinimized;    });    const closeBtn = document.getElementById('close-btn');    closeBtn.addEventListener('click', () => {        if (window.roomSubscriptionSocket) {            window.roomSubscriptionSocket.close();            delete window.roomSubscriptionSocket;        }        document.body.removeChild(overlay);    });    function updateRoomIdDisplay() {        const currentUrl = window.location.href;        const isRoomPage = currentUrl.includes('mocapmarketapi.onrender.com/room/');        let roomIdInfo = '';        if (isRoomPage) {            const urlParts = currentUrl.split('/');            const roomIndex = urlParts.indexOf('room');            if (roomIndex !== -1 && roomIndex < urlParts.length - 1) {                const roomId = urlParts[roomIndex + 1];                if (roomId) {                    roomIdInfo = `                    <div class="bg-gray-700 px-3 py-2 rounded-md text-white flex items-center justify-between text-xs">                        <div class="flex items-center">                            <span class="px-2 py-1 rounded">${roomId}</span>                        </div>                        <button class="bg-gray-800 hover:bg-gray-600 text-white text-xs py-0.5 px-1.5 rounded transition duration-200 flex items-center"                                 onclick="copyToClipboard('${roomId}', this)">                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" viewBox="0 0 20 20" fill="currentColor">                                <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />                                <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />                            </svg>                            Copy                        </button>                    </div>`;                    fetchRoomInformation(roomId);                }            }        }        const roomIdInfoContainer = document.getElementById('room-id-info');        if (roomIdInfoContainer) {            if (roomIdInfo) {                roomIdInfoContainer.innerHTML = roomIdInfo;            } else {                roomIdInfoContainer.innerHTML = `                <p class="text-gray-300">                    Current room information will appear here when you join a room.                </p>`;            }        }    }    function fetchRoomInformation(roomId) {        const roomIdInfoContainer = document.getElementById('room-id-info');        if (!roomIdInfoContainer) {            console.warn('Room ID info container not found. Retrying in 500ms...');            setTimeout(() => fetchRoomInformation(roomId), 500);            return;        }        roomIdInfoContainer.innerHTML = `        <div class="bg-gray-700 px-3 py-2 rounded-md text-white text-xs">            <div class="flex items-center">                <svg class="animate-spin h-4 w-4 mr-2 text-yellow-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>                </svg>                <span>Loading room information...</span>            </div>        </div>`;        const socket = new WebSocket('wss://energized-porcupine-393.convex.cloud/api/1.21.0/sync');        window.roomSubscriptionSocket = socket;        socket.addEventListener('open', (event) => {            socket.send(JSON.stringify({                "type": "ModifyQuerySet",                "baseVersion": 0,                "newVersion": 2,                "modifications": [{                    "type": "Add",                    "queryId": 0,                    "udfPath": "rooms:getRoom",                    "args": [{ "roomId": roomId }]                }]            }));        });        socket.addEventListener('message', (event) => {            const container = document.getElementById('room-id-info');            if (!container) {                socket.close();                delete window.roomSubscriptionSocket;                return;            }            try {                const data = JSON.parse(event.data);                if (data.type === "Transition" &&                    data.modifications &&                    data.modifications.length > 0 &&                    data.modifications[0].type === "QueryUpdated" &&                    data.modifications[0].value) {                    const roomData = data.modifications[0].value;                    window.currentRoomData = roomData;                    const roomName = roomData.roomName || "Unnamed Room";                    const ownerId = roomData.owner || "Unknown";                    let ownerName = "Unknown";                    if (roomData.acceptedPlayers && roomData.acceptedPlayers.length > 0) {                        const ownerPlayer = roomData.acceptedPlayers.find(player => player.id === ownerId);                        if (ownerPlayer) {                            ownerName = ownerPlayer.name;                        }                    }                    container.innerHTML = `                    <div class="w-full bg-gray-700 px-3 py-2 rounded-md text-white space-y-1 text-xs">                        <div class="flex flex-col">                            <div class="flex flex-col items-start">                                <div class="flex flex-row items-center justify-between w-full">                                    <div class="flex items-center">                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" class="mr-1 text-yellow-500" viewBox="0 0 20 20" fill="currentColor">                                            <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd" />                                        </svg>                                        <span style="width: 60px;" class="font-semibold">Room ID</span>                                    </div>                                </div>                                <div class="flex flex-row items-center justify-between w-full">                                    <span class="ml-2">${roomId}</span>                                    <button class="bg-gray-800 hover:bg-gray-600 text-white text-xs py-0.5 px-1.5 rounded transition duration-200 flex items-center"                                             onclick="copyToClipboard('${roomId}', this)">                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" class="mr-1" viewBox="0 0 20 20" fill="currentColor">                                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />                                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />                                        </svg>                                        Copy                                    </button>                                </div>                            </div>                            <div class="flex flex-col items-start mt-1">                                <div class="flex flex-row items-center">                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" class="mr-1 text-yellow-500" viewBox="0 0 20 20" fill="currentColor">                                    <path fill-rule="evenodd" d="M10 2a4 4 0 00-4 4v1H5a1 1 0 00-.994.89l-1 9A1 1 0 004 18h12a1 1 0 00.994-1.11l-1-9A1 1 0 0015 7h-1V6a4 4 0 00-4-4zm2 5V6a2 2 0 10-4 0v1h4zm-6 3a1 1 0 112 0 1 1 0 01-2 0zm7-1a1 1 0 100 2 1 1 0 000-2z" clip-rule="evenodd" />                                </svg>                                <span class="font-semibold">Room Name</span>                                </div>                                <span class="ml-2">${roomName}</span>                            </div>                            <div class="flex flex-col items-start mt-1">                                <div class="flex flex-row items-center">                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" class="mr-1 text-yellow-500" viewBox="0 0 20 20" fill="currentColor">                                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-6-3a2 2 0 11-4 0 2 2 0 014 0zm-2 4a5 5 0 00-4.546 2.916A5.986 5.986 0 0010 16a5.986 5.986 0 004.546-2.084A5 5 0 0010 11z" clip-rule="evenodd" />                                </svg>                                <span class="font-semibold">Owner</span>                                </div>                                <span class="ml-2">${ownerName} (<span style="text-overflow: ellipsis;overflow: hidden;max-width: 100%;white-space: nowrap;" class="text-gray-400">${ownerId}</span>)</span>                            </div>                        </div>                    </div>`;                    updatePendingPlayersContainer(roomData.pendingPlayers || [], roomId);                    updatePlayersContainer(roomData.acceptedPlayers || []);                    if (roomData.phase === 'voting') {                        const playerIdToName = {};                        if (roomData.acceptedPlayers && roomData.acceptedPlayers.length > 0) {                            roomData.acceptedPlayers.forEach(player => {                                playerIdToName[player.id] = player.name;                            });                        }                        updateVotingSummarySection(roomData, playerIdToName);                    }                    updateSubscriptionStatus('connected');                }            } catch (error) {                console.error('Error parsing WebSocket message:', error);            }        });        socket.addEventListener('error', (event) => {            console.error('WebSocket error:', event);            const container = document.getElementById('room-id-info');            if (!container) return;            container.innerHTML = `            <div class="bg-red-100 border border-red-400 text-red-800 px-4 py-2 rounded-md">                <div class="flex items-center">                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />                    </svg>                    <span>Error connecting to server. Room ID: ${roomId}</span>                </div>            </div>`;            updateSubscriptionStatus('error');        });        const timeoutId = setTimeout(() => {            if (socket.readyState !== WebSocket.CLOSED && socket.readyState !== WebSocket.OPEN) {                const container = document.getElementById('room-id-info');                if (!container) return;                container.innerHTML = `                <div class="bg-red-100 border border-red-400 text-red-800 px-4 py-2 rounded-md">                    <div class="flex items-center">                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />                        </svg>                        <span>Request timed out. Room ID: ${roomId}</span>                    </div>                </div>`;                updateSubscriptionStatus('error');            }        }, 10000);        socket.addEventListener('open', () => {            clearTimeout(timeoutId);        });        socket.addEventListener('close', () => {            clearTimeout(timeoutId);            updateSubscriptionStatus('disconnected');            setTimeout(() => {                if (document.getElementById('room-id-info')) {                    console.log('Attempting to reconnect to room subscription...');                    fetchRoomInformation(roomId);                }            }, 5000);        });    }    function updateSubscriptionStatus(status) {        const overlayHeader = document.getElementById('overlay-header');        if (!overlayHeader) return;        let statusIndicator = document.getElementById('subscription-status');        if (!statusIndicator) {            statusIndicator = document.createElement('div');            statusIndicator.id = 'subscription-status';            statusIndicator.className = 'text-xs flex items-center mt-1';            overlayHeader.appendChild(statusIndicator);        }        switch (status) {            case 'disconnected':                statusIndicator.className = 'text-xs text-yellow-500 flex items-center mt-1';                statusIndicator.innerHTML = `                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" class="mr-1" viewBox="0 0 20 20" fill="currentColor">                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />                    </svg>                    Connection lost - reconnecting...                `;                break;            case 'error':                statusIndicator.className = 'text-xs text-red-500 flex items-center mt-1';                statusIndicator.innerHTML = `                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" class="mr-1" viewBox="0 0 20 20" fill="currentColor">                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />                    </svg>                    Connection error                `;                break;        }    }    function updatePlayersContainer(players) {        const playersContainer = document.getElementById('players-container');        if (!playersContainer) return;        const playerInfoMessage = document.querySelector('#players-container').previousElementSibling;        if (players && players.length > 0) {            playerInfoMessage.style.display = 'none';        } else {            playerInfoMessage.style.display = 'block';        }        let playersHTML = '';        const roomData = window.currentRoomData || {};        const roles = roomData.roles || {};        const gameStarted = roomData.phase && roomData.phase !== 'waiting' && Object.keys(roles).length > 0;        const isVotingPhase = roomData.phase === 'voting';        const dayVotes = roomData.dayVotes || {};        const playerIdToName = {};        players.forEach(player => {            playerIdToName[player.id] = player.name;        });        players.forEach(player => {            const statusColor = player.alive ? 'text-green-500' : 'text-red-600';            const statusText = player.alive ? 'Alive' : 'Dead';            const readyStatus = player.ready ? 'Ready' : 'Not Ready';            const readyColor = player.ready ? 'text-green-500' : 'text-yellow-500';            const playerRole = roles[player.id] || 'N/A';            const roleDisplay = playerRole !== 'N/A' ? ` (${playerRole})` : '';            const readyButtonTitle = player.ready ? 'Force Unready' : 'Force Ready';            const readyButtonIcon = player.ready                ? '<path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />'                : '<path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />';            let secondLineDiv = '';            if (!player.alive && player.deadReason) {                secondLineDiv = `                <div class="mt-1 ml-6 text-gray-300">                    <span class="text-red-400">Death Reason: ${player.deadReason}</span>                </div>`;            }            if (isVotingPhase && player.alive) {                const votingFor = dayVotes[player.id];                let votingDisplay = 'Not voted yet';                let votingColor = 'text-yellow-500';                if (votingFor && playerIdToName[votingFor]) {                    votingDisplay = `Voting for: ${playerIdToName[votingFor]}`;                    votingColor = 'text-blue-400';                }                if (secondLineDiv === '') {                    secondLineDiv = `                    <div class="mt-1 ml-6 text-gray-300">                        <span class="${votingColor}">${votingDisplay}</span>                    </div>`;                } else {                    secondLineDiv += `                    <div class="mt-1 ml-6 text-gray-300">                        <span class="${votingColor}">${votingDisplay}</span>                    </div>`;                }            }            playersHTML += `            <div class="bg-gray-700 px-3 py-2 rounded-md flex flex-col text-xs">                <div class="flex justify-between items-center">                    <div class="flex items-center">                        <div class="flex mr-2">                            <button class="bg-red-900 hover:bg-red-600 text-white text-xs py-0.5 px-1.5 rounded mr-1 transition duration-200"                                     title="Kick Player"                                     onclick="kickPlayer('${player.id}', '${player.name}')">                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"  viewBox="0 0 20 20" fill="currentColor">                                    <path d="M11 6a3 3 0 11-6 0 3 3 0 016 0zM14 17a6 6 0 00-12 0h12zM13 8a1 1 0 100 2h4a1 1 0 100-2h-4z" />                                </svg>                            </button>                            <button class="bg-gray-800 hover:bg-gray-600 text-white text-xs py-0.5 px-1.5 rounded transition duration-200"                                     title="${readyButtonTitle}"                                     onclick="toggleReady('${player.id}', '${player.name}', ${!player.ready})">                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 20 20" fill="currentColor">                                    ${readyButtonIcon}                                </svg>                            </button>                        </div>                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1 text-gray-300" viewBox="0 0 20 20" fill="currentColor">                            <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />                        </svg>                        <span>${player.name}</span>                    </div>                    <div class="flex items-center">                        <span class="${statusColor} mr-2">${statusText}${roleDisplay}</span>                        <span class="${readyColor}">${readyStatus}</span>                    </div>                </div>                ${secondLineDiv}            </div>`;        });        playersContainer.innerHTML = playersHTML;        updateGamePhaseSection(roomData);        updateRoleConfigSection(roomData);    }    function updateVotingSummarySection(roomData, playerIdToName) {        let votingSummarySection = document.getElementById('voting-summary-section');        if (!votingSummarySection) {            const gamePhaseSection = document.getElementById('game-phase-section');            if (!gamePhaseSection) return;            votingSummarySection = document.createElement('div');            votingSummarySection.id = 'voting-summary-section';            votingSummarySection.className = 'bg-gray-800 bg-opacity-50 p-3 rounded-md';            votingSummarySection.innerHTML = `                <h2 class="text-lg font-bold text-yellow-500 mb-2 flex items-center">                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />                    </svg>                    Voting Summary                </h2>                <div id="voting-summary-content" class="space-y-2">                    <!-- Voting summary content will be populated here -->                </div>            `;            gamePhaseSection.parentNode.insertBefore(votingSummarySection, gamePhaseSection.nextSibling);        }        const votingSummaryContent = document.getElementById('voting-summary-content');        if (!votingSummaryContent) return;        const dayVotes = roomData.dayVotes || {};        const voteCounts = {};        Object.values(dayVotes).forEach(targetId => {            voteCounts[targetId] = (voteCounts[targetId] || 0) + 1;        });        const sortedVotes = Object.entries(voteCounts).sort((a, b) => b[1] - a[1]);        if (sortedVotes.length === 0) {            votingSummaryContent.innerHTML = `            <p class="text-gray-300 text-xs">                No votes have been cast yet.            </p>`;            return;        }        let votingSummaryHTML = `        <div class="bg-gray-700 px-3 py-2 rounded-md">            <div class="space-y-1 text-xs">`;        sortedVotes.forEach(([targetId, count]) => {            const playerName = playerIdToName[targetId] || 'Unknown Player';            votingSummaryHTML += `            <div class="flex items-center justify-between">                <span class="text-white font-semibold">${playerName}:</span>                <span class="text-red-400">${count} vote${count !== 1 ? 's' : ''}</span>            </div>`;        });        votingSummaryHTML += `            </div>        </div>`;        votingSummaryContent.innerHTML = votingSummaryHTML;    }    function updateGamePhaseSection(roomData) {        let gamePhaseSectionExists = document.getElementById('game-phase-section');        if (!gamePhaseSectionExists) {            const playersSection = document.querySelector('.bg-gray-800.bg-opacity-50.p-3.rounded-md:nth-child(3)');            if (!playersSection) return;            const gamePhaseSection = document.createElement('div');            gamePhaseSection.id = 'game-phase-section';            gamePhaseSection.className = 'bg-gray-800 bg-opacity-50 p-3 rounded-md';            gamePhaseSection.innerHTML = `                <h2 class="text-lg font-bold text-yellow-500 mb-2 flex items-center">                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" />                    </svg>                    Game Status                </h2>                <div id="game-phase-content" class="space-y-2">                    <!-- Game phase content will be populated here -->                </div>            `;            playersSection.parentNode.insertBefore(gamePhaseSection, playersSection);        }        const gamePhaseContent = document.getElementById('game-phase-content');        if (!gamePhaseContent) return;        const phase = roomData.phase || 'waiting';        let phaseDisplay = 'Waiting for players';        let phaseColor = 'text-gray-300';        switch (phase) {            case 'night':                phaseDisplay = 'Night Phase';                phaseColor = 'text-blue-400';                break;            case 'day':                phaseDisplay = 'Day Phase';                phaseColor = 'text-yellow-400';                break;            case 'voting':                phaseDisplay = 'Voting Phase';                phaseColor = 'text-red-400';                break;            case 'gameOver':                phaseDisplay = 'Game Over';                phaseColor = 'text-purple-400';                break;        }        gamePhaseContent.innerHTML = `        <div class="bg-gray-700 px-3 py-2 rounded-md">            <div class="flex items-center justify-between">                <div class="flex items-center">                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1 ${phaseColor}" viewBox="0 0 20 20" fill="currentColor">                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" />                    </svg>                    <span class="font-semibold">Current Phase:</span>                </div>                <span class="${phaseColor} font-semibold">${phaseDisplay}</span>            </div>        </div>        `;    }    function updateRoleConfigSection(roomData) {        let roleConfigSectionExists = document.getElementById('role-config-section');        if (!roleConfigSectionExists) {            const closeButtonDiv = document.querySelector('.flex.justify-end');            if (!closeButtonDiv) return;            const roleConfigSection = document.createElement('div');            roleConfigSection.id = 'role-config-section';            roleConfigSection.className = 'bg-gray-800 bg-opacity-50 p-3 rounded-md';            roleConfigSection.innerHTML = `                <h2 class="text-lg font-bold text-yellow-500 mb-2 flex items-center">                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">                        <path fill-rule="evenodd" d="M18 8a6 6 0 01-7.743 5.743L10 14l-1 1-1 1H6v-1l1-1 1-1-.257-.257A6 6 0 1118 8zm-6-4a1 1 0 100 2 2 2 0 012 2 1 1 0 102 0 4 4 0 00-4-4z" clip-rule="evenodd" />                    </svg>                    Role Configuration                </h2>                <div id="role-config-content" class="space-y-2">                    <!-- Role configuration content will be populated here -->                </div>            `;            closeButtonDiv.parentNode.insertBefore(roleConfigSection, closeButtonDiv);        }        const roleConfigContent = document.getElementById('role-config-content');        if (!roleConfigContent) return;        const rolesConfig = roomData.rolesConfig || {};        if (Object.keys(rolesConfig).length === 0) {            roleConfigContent.innerHTML = `            <p class="text-gray-300 text-xs">                No role configuration available.            </p>`;            return;        }        let roleConfigHTML = `        <div class="bg-gray-700 px-3 py-2 rounded-md">            <div class="grid grid-cols-2 gap-2 text-xs">`;        for (const [role, count] of Object.entries(rolesConfig)) {            let roleColor = 'text-gray-300';            switch (role.toLowerCase()) {                case 'mafia':                    roleColor = 'text-red-400';                    break;                case 'doctor':                    roleColor = 'text-green-400';                    break;                case 'investigator':                    roleColor = 'text-blue-400';                    break;                case 'citizen':                    roleColor = 'text-yellow-400';                    break;            }            roleConfigHTML += `            <div class="flex items-center justify-between">                <span class="${roleColor} font-semibold">${role.charAt(0).toUpperCase() + role.slice(1)}:</span>                <span class="text-white">${count}</span>            </div>`;        }        roleConfigHTML += `            </div>        </div>`;        roleConfigContent.innerHTML = roleConfigHTML;    }    function updatePendingPlayersContainer(pendingPlayers, roomId) {        let pendingPlayersContainer = document.getElementById('pending-players-container');        if (!pendingPlayersContainer) {            const overlayContent = document.getElementById('overlay-content');            if (!overlayContent) return;            const roomInfoSection = overlayContent.querySelector('.bg-gray-800.bg-opacity-50.p-4.rounded-md');            if (!roomInfoSection) return;            const pendingPlayersSection = document.createElement('div');            pendingPlayersSection.className = 'bg-gray-800 bg-opacity-50 p-4 rounded-md';            pendingPlayersSection.innerHTML = `                <h2 class="text-xl font-bold text-yellow-500 mb-3 flex items-center">                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" viewBox="0 0 20 20" fill="currentColor">                        <path d="M8 9a3 3 0 100-6 3 3 0 000 6zM8 11a6 6 0 016 6H2a6 6 0 016-6zM16 7a1 1 0 10-2 0v1h-1a1 1 0 100 2h1v1a1 1 0 102 0v-1h1a1 1 0 100-2h-1V7z" />                    </svg>                    Pending Players                </h2>                                <div id="pending-players-container" class="space-y-2">                    <!-- Pending players will be populated here -->                </div>            `;            roomInfoSection.parentNode.insertBefore(pendingPlayersSection, roomInfoSection.nextSibling);            pendingPlayersContainer = document.getElementById('pending-players-container');        }        if (pendingPlayers.length === 0) {            pendingPlayersContainer.innerHTML = `                <p class="text-gray-300 text-xs">                    No pending players waiting to join.                </p>            `;            return;        }        let pendingPlayersHTML = '';        pendingPlayers.forEach(player => {            pendingPlayersHTML += `            <div class="bg-gray-700 px-3 py-2 rounded-md flex justify-between items-center text-xs">                <div class="flex items-center">                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1 text-gray-300" viewBox="0 0 20 20" fill="currentColor">                        <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />                    </svg>                    <span>${player.name}</span>                </div>                <div class="flex items-center">                    <button class="bg-green-700 hover:bg-green-600 text-white text-xs py-0.5 px-1.5 rounded mr-1 transition duration-200"                             title="Accept Player"                             onclick="acceptPlayer('${player.id}', '${player.name}', '${roomId}')">                        <svg width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />                        </svg>                    </button>                    <button class="bg-red-700 hover:bg-red-600 text-white text-xs py-0.5 px-1.5 rounded transition duration-200"                             title="Reject Player"                             onclick="rejectPlayer('${player.id}', '${player.name}', '${roomId}')">                        <svg width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />                        </svg>                    </button>                </div>            </div>`;        });        pendingPlayersContainer.innerHTML = pendingPlayersHTML;    }    function acceptPlayer(playerId, playerName, roomId) {        console.log(`Attempting to accept player: ${playerName} (${playerId})`);        if (!roomId) {            showNotification('error', `Cannot accept player: Room ID not found.`);            return;        }        const socket = new WebSocket('wss://energized-porcupine-393.convex.cloud/api/1.21.0/sync');        const loadingNotificationId = showNotification('loading', `Accepting player ${playerName}...`);        const requestId = generateRequestId();        socket.addEventListener('open', (event) => {            socket.send(JSON.stringify({                "type": "Mutation",                "requestId": requestId,                "udfPath": "rooms:acceptPlayer",                "args": [{                    "playerId": playerId,                    "roomId": roomId                }]            }));        });        socket.addEventListener('message', (event) => {            try {                const data = JSON.parse(event.data);                removeNotification(loadingNotificationId);                if (data.type === "MutationResponse" && data.requestId === requestId) {                    if (data.error) {                        showNotification('error', `Failed to accept ${playerName}: ${data.error.message || 'Unknown error'}`);                    } else {                        showNotification('success', `Successfully accepted ${playerName} into the room.`);                    }                }                socket.close();            } catch (error) {                console.error('Error parsing WebSocket message:', error);                removeNotification(loadingNotificationId);                showNotification('error', `Error processing response: ${error.message}`);                socket.close();            }        });        socket.addEventListener('error', (event) => {            console.error('WebSocket error:', event);            removeNotification(loadingNotificationId);            showNotification('error', `Connection error while trying to accept ${playerName}.`);        });        const timeoutId = setTimeout(() => {            if (socket.readyState !== WebSocket.CLOSED) {                socket.close();                removeNotification(loadingNotificationId);                showNotification('error', `Request timed out while trying to accept ${playerName}.`);            }        }, 10000);        socket.addEventListener('close', () => {            clearTimeout(timeoutId);        });    }    function rejectPlayer(playerId, playerName, roomId) {        console.log(`Attempting to reject player: ${playerName} (${playerId})`);        if (!roomId) {            showNotification('error', `Cannot reject player: Room ID not found.`);            return;        }        const socket = new WebSocket('wss://energized-porcupine-393.convex.cloud/api/1.21.0/sync');        const loadingNotificationId = showNotification('loading', `Rejecting player ${playerName}...`);        const requestId = generateRequestId();        socket.addEventListener('open', (event) => {            socket.send(JSON.stringify({                "type": "Mutation",                "requestId": requestId,                "udfPath": "rooms:declinePlayer",                "args": [{                    "playerId": playerId,                    "roomId": roomId                }]            }));        });        socket.addEventListener('message', (event) => {            try {                const data = JSON.parse(event.data);                removeNotification(loadingNotificationId);                if (data.type === "MutationResponse" && data.requestId === requestId) {                    if (data.error) {                        showNotification('error', `Failed to reject ${playerName}: ${data.error.message || 'Unknown error'}`);                    } else {                        showNotification('success', `Successfully rejected ${playerName} from the room.`);                    }                }                socket.close();            } catch (error) {                console.error('Error parsing WebSocket message:', error);                removeNotification(loadingNotificationId);                showNotification('error', `Error processing response: ${error.message}`);                socket.close();            }        });        socket.addEventListener('error', (event) => {            console.error('WebSocket error:', event);            removeNotification(loadingNotificationId);            showNotification('error', `Connection error while trying to reject ${playerName}.`);        });        const timeoutId = setTimeout(() => {            if (socket.readyState !== WebSocket.CLOSED) {                socket.close();                removeNotification(loadingNotificationId);                showNotification('error', `Request timed out while trying to reject ${playerName}.`);            }        }, 10000);        socket.addEventListener('close', () => {            clearTimeout(timeoutId);        });    }    let lastUrl = window.location.href;    window.addEventListener('popstate', updateRoomIdDisplay);    const urlObserver = new MutationObserver(function (mutations) {        const currentUrl = window.location.href;        if (lastUrl !== currentUrl) {            lastUrl = currentUrl;            updateRoomIdDisplay();        }    });    urlObserver.observe(document, { childList: true, subtree: true });    setInterval(function () {        const currentUrl = window.location.href;        if (lastUrl !== currentUrl) {            lastUrl = currentUrl;            updateRoomIdDisplay();        }    }, 1000);    function generateRequestId() {        return Math.floor(Math.random() * (99999 - 200 + 1)) + 200;    }    function kickPlayer(playerId, playerName) {        console.log(`Attempting to kick player: ${playerName} (${playerId})`);        const currentUrl = window.location.href;        const urlParts = currentUrl.split('/');        const roomIndex = urlParts.indexOf('room');        let roomId = null;        if (roomIndex !== -1 && roomIndex < urlParts.length - 1) {            roomId = urlParts[roomIndex + 1];        }        if (!roomId) {            showNotification('error', `Cannot kick player: Room ID not found.`);            return;        }        checkIfPlayerIsOwner(playerId, roomId, (isOwner) => {            if (isOwner) {                showNotification('error', `Cannot kick ${playerName}: He is the room owner.`);                return;            }            const socket = new WebSocket('wss://energized-porcupine-393.convex.cloud/api/1.21.0/sync');            const loadingNotificationId = showNotification('loading', `Kicking player ${playerName}...`);            const requestId = generateRequestId();            socket.addEventListener('open', (event) => {                const hostId = getCurrentUserId() || "07c67333-086e-4ada-a706-7596d4983f77";                socket.send(JSON.stringify({                    "type": "Mutation",                    "requestId": requestId,                    "udfPath": "rooms:kickPlayer",                    "args": [{                        "hostId": hostId,                        "playerId": playerId,                        "roomId": roomId                    }]                }));            });            socket.addEventListener('message', (event) => {                try {                    const data = JSON.parse(event.data);                    removeNotification(loadingNotificationId);                    if (data.type === "MutationResponse" && data.requestId === requestId) {                        if (data.error) {                            showNotification('error', `Failed to kick ${playerName}: ${data.error.message || 'Unknown error'}`);                        } else {                            showNotification('success', `Successfully kicked ${playerName} from the room.`);                        }                    }                    socket.close();                } catch (error) {                    console.error('Error parsing WebSocket message:', error);                    removeNotification(loadingNotificationId);                    showNotification('error', `Error processing response: ${error.message}`);                    socket.close();                }            });            socket.addEventListener('error', (event) => {                console.error('WebSocket error:', event);                removeNotification(loadingNotificationId);                showNotification('error', `Connection error while trying to kick ${playerName}.`);            });            const timeoutId = setTimeout(() => {                if (socket.readyState !== WebSocket.CLOSED) {                    socket.close();                    removeNotification(loadingNotificationId);                    showNotification('error', `Request timed out while trying to kick ${playerName}.`);                }            }, 10000);            socket.addEventListener('close', () => {                clearTimeout(timeoutId);            });        });    }    function checkIfPlayerIsOwner(playerId, roomId, callback) {        const socket = new WebSocket('wss://energized-porcupine-393.convex.cloud/api/1.21.0/sync');        const queryId = generateRequestId();        socket.addEventListener('open', (event) => {            socket.send(JSON.stringify({                "type": "ModifyQuerySet",                "baseVersion": 0,                "newVersion": 1,                "modifications": [{                    "type": "Add",                    "queryId": queryId,                    "udfPath": "rooms:getRoom",                    "args": [{ "roomId": roomId }]                }]            }));        });        socket.addEventListener('message', (event) => {            try {                const data = JSON.parse(event.data);                if (data.type === "Transition" &&                    data.modifications &&                    data.modifications.length > 0 &&                    data.modifications[0].type === "QueryUpdated" &&                    data.modifications[0].value) {                    const roomData = data.modifications[0].value;                    const isOwner = roomData.owner === playerId;                    socket.close();                    callback(isOwner);                }            } catch (error) {                console.error('Error parsing WebSocket message:', error);                socket.close();                callback(false);            }        });        socket.addEventListener('error', (event) => {            console.error('WebSocket error:', event);            socket.close();            callback(false);        });        const timeoutId = setTimeout(() => {            if (socket.readyState !== WebSocket.CLOSED) {                socket.close();                callback(false);            }        }, 5000);        socket.addEventListener('close', () => {            clearTimeout(timeoutId);        });    }    function toggleReady(playerId, playerName, setToReady) {        const readyAction = setToReady ? "ready" : "not ready";        console.log(`Attempting to set player ${playerName} (${playerId}) to ${readyAction}`);        const currentUrl = window.location.href;        const urlParts = currentUrl.split('/');        const roomIndex = urlParts.indexOf('room');        let roomId = null;        if (roomIndex !== -1 && roomIndex < urlParts.length - 1) {            roomId = urlParts[roomIndex + 1];        }        if (!roomId) {            showNotification('error', `Cannot set ready status: Room ID not found.`);            return;        }        const socket = new WebSocket('wss://energized-porcupine-393.convex.cloud/api/1.21.0/sync');        const loadingNotificationId = showNotification('loading', `Setting ${playerName} to ${readyAction}...`);        const requestId = generateRequestId();        socket.addEventListener('open', (event) => {            socket.send(JSON.stringify({                "type": "Mutation",                "requestId": requestId,                "udfPath": "rooms:setReady",                "args": [{                    "playerId": playerId,                    "ready": setToReady,                    "roomId": roomId                }]            }));        });        socket.addEventListener('message', (event) => {            try {                const data = JSON.parse(event.data);                removeNotification(loadingNotificationId);                if (data.type === "MutationResponse" && data.requestId === requestId) {                    if (data.error) {                        showNotification('error', `Failed to set ${playerName} to ${readyAction}: ${data.error.message || 'Unknown error'}`);                    } else {                        showNotification('success', `Successfully set ${playerName} to ${readyAction}.`);                    }                }                socket.close();            } catch (error) {                console.error('Error parsing WebSocket message:', error);                removeNotification(loadingNotificationId);                showNotification('error', `Error processing response: ${error.message}`);                socket.close();            }        });        socket.addEventListener('error', (event) => {            console.error('WebSocket error:', event);            removeNotification(loadingNotificationId);            showNotification('error', `Connection error while trying to set ${playerName} to ${readyAction}.`);        });        const timeoutId = setTimeout(() => {            if (socket.readyState !== WebSocket.CLOSED) {                socket.close();                removeNotification(loadingNotificationId);                showNotification('error', `Request timed out while trying to set ${playerName} to ${readyAction}.`);            }        }, 10000);        socket.addEventListener('close', () => {            clearTimeout(timeoutId);        });    }    function showNotification(type, message) {        const playersContainer = document.getElementById('players-container');        if (!playersContainer) return null;        const notificationId = `notification-${Date.now()}`;        let bgColor, borderColor, textColor, icon;        switch (type) {            case 'success':                bgColor = 'bg-green-100';                borderColor = 'border-green-400';                textColor = 'text-green-800';                icon = '<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />';                break;            case 'error':                bgColor = 'bg-red-100';                borderColor = 'border-red-400';                textColor = 'text-red-800';                icon = '<path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />';                break;            case 'loading':                bgColor = 'bg-blue-100';                borderColor = 'border-blue-400';                textColor = 'text-blue-800';                icon = '<circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>';                break;            default:                bgColor = 'bg-yellow-100';                borderColor = 'border-yellow-400';                textColor = 'text-yellow-800';                icon = '<path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />';        }        const notification = document.createElement('div');        notification.id = notificationId;        notification.className = `${bgColor} border ${borderColor} ${textColor} px-3 py-1.5 rounded-md mb-2 text-xs`;        notification.innerHTML = `            <div class="flex items-center justify-between">                <div class="flex items-center">                    <svg xmlns="http://www.w3.org/2000/svg" class="${type === 'loading' ? 'animate-spin' : ''} h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor">                        ${icon}                    </svg>                    <span>${message}</span>                </div>                <button onclick="document.getElementById('${notificationId}').remove()" class="${textColor}">                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor">                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />                    </svg>                </button>            </div>        `;        playersContainer.insertBefore(notification, playersContainer.firstChild);        if (type !== 'loading') {            setTimeout(() => removeNotification(notificationId), 5000);        }        return notificationId;    }    function removeNotification(notificationId) {        if (!notificationId) return;        const notificationElement = document.getElementById(notificationId);        if (notificationElement) {            notificationElement.remove();        }    }    function getCurrentUserId() {        const userId = localStorage.getItem('userId');        if (userId) return userId;        return null;    }    window.copyToClipboard = function (text, button) {        const input = document.createElement('input');        input.value = text;        document.body.appendChild(input);        input.select();        input.setSelectionRange(0, 99999);        document.execCommand('copy');        document.body.removeChild(input);        const originalHTML = button.innerHTML;        button.innerHTML = `            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1 text-green-400" viewBox="0 0 20 20" fill="currentColor">                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />            </svg>            Copied!        `;        showNotification('success', `Room ID copied to clipboard!`);        setTimeout(() => {            button.innerHTML = originalHTML;        }, 2000);    };    window.kickPlayer = kickPlayer;    window.toggleReady = toggleReady;    window.acceptPlayer = acceptPlayer;    window.rejectPlayer = rejectPlayer;    document.getElementById('start-game-btn')?.addEventListener('click', startGame);    document.getElementById('delete-room-btn')?.addEventListener('click', deleteRoom);    function startGame() {        const currentUrl = window.location.href;        const urlParts = currentUrl.split('/');        const roomIndex = urlParts.indexOf('room');        let roomId = null;        if (roomIndex !== -1 && roomIndex < urlParts.length - 1) {            roomId = urlParts[roomIndex + 1];        }        if (!roomId) {            showNotification('error', `Cannot start game: Room ID not found.`);            return;        }        const socket = new WebSocket('wss://energized-porcupine-393.convex.cloud/api/1.21.0/sync');        const loadingNotificationId = showNotification('loading', `Starting game...`);        const requestId = generateRequestId();        socket.addEventListener('open', (event) => {            socket.send(JSON.stringify({                "type": "Mutation",                "requestId": requestId,                "udfPath": "rooms:startGame",                "args": [{                    "roomId": roomId                }]            }));        });        socket.addEventListener('message', (event) => {            try {                const data = JSON.parse(event.data);                removeNotification(loadingNotificationId);                if (data.type === "MutationResponse" && data.requestId === requestId) {                    if (data.error) {                        showNotification('error', `Failed to start game: ${data.error.message || 'Unknown error'}`);                    } else {                        showNotification('success', `Game started successfully!`);                    }                }                socket.close();            } catch (error) {                console.error('Error parsing WebSocket message:', error);                removeNotification(loadingNotificationId);                showNotification('error', `Error processing response: ${error.message}`);                socket.close();            }        });        socket.addEventListener('error', (event) => {            console.error('WebSocket error:', event);            removeNotification(loadingNotificationId);            showNotification('error', `Connection error while trying to start the game.`);        });        const timeoutId = setTimeout(() => {            if (socket.readyState !== WebSocket.CLOSED) {                socket.close();                removeNotification(loadingNotificationId);                showNotification('error', `Request timed out while trying to start the game.`);            }        }, 10000);        socket.addEventListener('close', () => {            clearTimeout(timeoutId);        });    }    function deleteRoom() {        const currentUrl = window.location.href;        const urlParts = currentUrl.split('/');        const roomIndex = urlParts.indexOf('room');        let roomId = null;        if (roomIndex !== -1 && roomIndex < urlParts.length - 1) {            roomId = urlParts[roomIndex + 1];        }        if (!roomId) {            showNotification('error', `Cannot delete room: Room ID not found.`);            return;        }        const socket = new WebSocket('wss://energized-porcupine-393.convex.cloud/api/1.21.0/sync');        const loadingNotificationId = showNotification('loading', `Deleting room...`);        const requestId = generateRequestId();        socket.addEventListener('open', (event) => {            socket.send(JSON.stringify({                "type": "Mutation",                "requestId": requestId,                "udfPath": "rooms:deleteRoom",                "args": [{                    "roomId": roomId                }]            }));        });        socket.addEventListener('message', (event) => {            try {                const data = JSON.parse(event.data);                removeNotification(loadingNotificationId);                if (data.type === "MutationResponse" && data.requestId === requestId) {                    if (data.error) {                        showNotification('error', `Failed to delete room: ${data.error.message || 'Unknown error'}`);                    } else {                        showNotification('success', `Room deleted successfully!`);                        const overlay = document.getElementById('custom-overlay');                        if (overlay) {                            if (window.roomSubscriptionSocket) {                                window.roomSubscriptionSocket.close();                                delete window.roomSubscriptionSocket;                            }                            document.body.removeChild(overlay);                        }                    }                }                socket.close();            } catch (error) {                console.error('Error parsing WebSocket message:', error);                removeNotification(loadingNotificationId);                showNotification('error', `Error processing response: ${error.message}`);                socket.close();            }        });        socket.addEventListener('error', (event) => {            console.error('WebSocket error:', event);            removeNotification(loadingNotificationId);            showNotification('error', `Connection error while trying to delete the room.`);        });        const timeoutId = setTimeout(() => {            if (socket.readyState !== WebSocket.CLOSED) {                socket.close();                removeNotification(loadingNotificationId);                showNotification('error', `Request timed out while trying to delete the room.`);            }        }, 10000);        socket.addEventListener('close', () => {            clearTimeout(timeoutId);        });    }    window.protectPlayer = function (playerId, playerName) {        console.log(`Protect action for player: ${playerName} (${playerId})`);        const currentUrl = window.location.href;        const urlParts = currentUrl.split('/');        const roomIndex = urlParts.indexOf('room');        let roomId = null;        if (roomIndex !== -1 && roomIndex < urlParts.length - 1) {            roomId = urlParts[roomIndex + 1];        }        if (!roomId) {            showNotification('error', `Cannot protect player: Room ID not found.`);            return;        }        const roomData = window.currentRoomData || {};        let doctorId = null;        const roles = roomData.roles || {};        for (const [playerId, role] of Object.entries(roles)) {            if (role.toLowerCase() === 'doctor') {                doctorId = playerId;                break;            }        }        if (!doctorId) {            doctorId = localStorage.getItem('userId');            if (!doctorId) {                doctorId = prompt("Please enter your doctor ID to perform this action:");                if (doctorId) {                    localStorage.setItem('userId', doctorId);                }            }        }        if (!doctorId) {            showNotification('error', `Cannot protect player: Doctor ID not found.`);            return;        }        const socket = new WebSocket('wss://energized-porcupine-393.convex.cloud/api/1.21.0/sync');        const loadingNotificationId = showNotification('loading', `Protecting ${playerName}...`);        const requestId = Math.floor(Math.random() * (99999 - 200 + 1)) + 200;        socket.addEventListener('open', (event) => {            socket.send(JSON.stringify({                "type": "Mutation",                "requestId": requestId,                "udfPath": "rooms:doctorNightAction",                "args": [{                    "doctorId": doctorId,                    "roomId": roomId,                    "targetId": playerId                }]            }));        });        socket.addEventListener('message', (event) => {            try {                const data = JSON.parse(event.data);                removeNotification(loadingNotificationId);                if (data.type === "MutationResponse" && data.requestId === requestId) {                    if (data.error) {                        showNotification('error', `Failed to protect ${playerName}: ${data.error.message || 'Unknown error'}`);                    } else {                        showNotification('success', `You have chosen to protect ${playerName} tonight.`);                    }                }                socket.close();            } catch (error) {                console.error('Error parsing WebSocket message:', error);                removeNotification(loadingNotificationId);                showNotification('error', `Error processing response: ${error.message}`);                socket.close();            }        });        socket.addEventListener('error', (event) => {            console.error('WebSocket error:', event);            removeNotification(loadingNotificationId);            showNotification('error', `Connection error while trying to protect ${playerName}.`);        });        const timeoutId = setTimeout(() => {            if (socket.readyState !== WebSocket.CLOSED) {                socket.close();                removeNotification(loadingNotificationId);                showNotification('error', `Request timed out while trying to protect ${playerName}.`);            }        }, 10000);        socket.addEventListener('close', () => {            clearTimeout(timeoutId);        });    };    window.killPlayer = function (playerId, playerName) {        console.log(`Kill action for player: ${playerName} (${playerId})`);        const currentUrl = window.location.href;        const urlParts = currentUrl.split('/');        const roomIndex = urlParts.indexOf('room');        let roomId = null;        if (roomIndex !== -1 && roomIndex < urlParts.length - 1) {            roomId = urlParts[roomIndex + 1];        }        if (!roomId) {            showNotification('error', `Cannot kill player: Room ID not found.`);            return;        }        const roomData = window.currentRoomData || {};        let mafiaId = null;        const roles = roomData.roles || {};        for (const [playerId, role] of Object.entries(roles)) {            if (role.toLowerCase() === 'mafia') {                mafiaId = playerId;                break;            }        }        if (!mafiaId) {            mafiaId = localStorage.getItem('userId');            if (!mafiaId) {                mafiaId = prompt("Please enter your mafia ID to perform this action:");                if (mafiaId) {                    localStorage.setItem('userId', mafiaId);                }            }        }        if (!mafiaId) {            showNotification('error', `Cannot kill player: Mafia ID not found.`);            return;        }        const socket = new WebSocket('wss://energized-porcupine-393.convex.cloud/api/1.21.0/sync');        const loadingNotificationId = showNotification('loading', `Targeting ${playerName} for elimination...`);        const requestId = Math.floor(Math.random() * (99999 - 200 + 1)) + 200;        socket.addEventListener('open', (event) => {            socket.send(JSON.stringify({                "type": "Mutation",                "requestId": requestId,                "udfPath": "rooms:mafiaNightAction",                "args": [{                    "mafiaId": mafiaId,                    "roomId": roomId,                    "targetId": playerId                }]            }));        });        socket.addEventListener('message', (event) => {            try {                const data = JSON.parse(event.data);                removeNotification(loadingNotificationId);                if (data.type === "MutationResponse" && data.requestId === requestId) {                    if (data.error) {                        showNotification('error', `Failed to target ${playerName}: ${data.error.message || 'Unknown error'}`);                    } else {                        showNotification('success', `You have chosen to eliminate ${playerName} tonight.`);                    }                }                socket.close();            } catch (error) {                console.error('Error parsing WebSocket message:', error);                removeNotification(loadingNotificationId);                showNotification('error', `Error processing response: ${error.message}`);                socket.close();            }        });        socket.addEventListener('error', (event) => {            console.error('WebSocket error:', event);            removeNotification(loadingNotificationId);            showNotification('error', `Connection error while trying to target ${playerName}.`);        });        const timeoutId = setTimeout(() => {            if (socket.readyState !== WebSocket.CLOSED) {                socket.close();                removeNotification(loadingNotificationId);                showNotification('error', `Request timed out while trying to target ${playerName}.`);            }        }, 10000);        socket.addEventListener('close', () => {            clearTimeout(timeoutId);        });    };    window.investigatePlayer = function (playerId, playerName) {        console.log(`Investigate action for player: ${playerName} (${playerId})`);        showNotification('info', `Investigation selected for ${playerName}`);    };})();
